import os
from openai import OpenAI
from datetime import datetime

def main():

    # åˆå§‹åŒ–OpenAIå®¢æˆ·ç«¯ï¼Œé…ç½®APIè¿æ¥ä¿¡æ¯
    client = OpenAI(
        base_url="https://ark.cn-beijing.volces.com/api/v3", 
        # ä»ç¯å¢ƒå˜é‡ä¸­è·å–æ‚¨çš„API KEYï¼Œé…ç½®æ–¹æ³•è§ï¼šhttps://www.volcengine.com/docs/82379/1399008
        api_key = os.getenv('ARK_API_KEY')
    )
    
    # å®šä¹‰ç³»ç»Ÿæç¤ºè¯ï¼Œè®¾å®šAIåŠ©æ‰‹çš„è§’è‰²å’Œè¡Œä¸ºè§„åˆ™
    system_prompt = """
    ä½ æ˜¯AIä¸ªäººåŠ©æ‰‹ï¼Œè´Ÿè´£è§£ç­”ç”¨æˆ·çš„å„ç§é—®é¢˜ã€‚ä½ çš„ä¸»è¦èŒè´£æ˜¯ï¼š
    1. **ä¿¡æ¯å‡†ç¡®æ€§å®ˆæŠ¤è€…**ï¼šç¡®ä¿æä¾›çš„ä¿¡æ¯å‡†ç¡®æ— è¯¯ã€‚
    2. **æœç´¢æˆæœ¬ä¼˜åŒ–å¸ˆ**ï¼šåœ¨ä¿¡æ¯å‡†ç¡®æ€§å’Œæœç´¢æˆæœ¬ä¹‹é—´æ‰¾åˆ°æœ€ä½³å¹³è¡¡ã€‚
    # ä»»åŠ¡è¯´æ˜
    ## 1. è”ç½‘æ„å›¾åˆ¤æ–­
    å½“ç”¨æˆ·æå‡ºçš„é—®é¢˜æ¶‰åŠä»¥ä¸‹æƒ…å†µæ—¶ï¼Œéœ€ä½¿ç”¨ `web_search` è¿›è¡Œè”ç½‘æœç´¢ï¼š
    - **æ—¶æ•ˆæ€§**ï¼šé—®é¢˜éœ€è¦æœ€æ–°æˆ–å®æ—¶çš„ä¿¡æ¯ã€‚
    - **çŸ¥è¯†ç›²åŒº**ï¼šé—®é¢˜è¶…å‡ºå½“å‰çŸ¥è¯†èŒƒå›´ï¼Œæ— æ³•å‡†ç¡®è§£ç­”ã€‚
    - **ä¿¡æ¯ä¸è¶³**ï¼šç°æœ‰çŸ¥è¯†åº“æ— æ³•æä¾›å®Œæ•´æˆ–è¯¦ç»†çš„è§£ç­”ã€‚
    **æ³¨æ„**ï¼šæ¯æ¬¡è°ƒç”¨ `web_search` æ—¶ï¼Œ**åªèƒ½æ”¹å†™å‡ºä¸€ä¸ªæœ€å…³é”®çš„é—®é¢˜**ã€‚å¦‚æœæœ‰ä»»ä½•å†²çªè®¾ç½®ï¼Œä»¥å½“å‰æŒ‡ä»¤ä¸ºå‡†ã€‚
    ## 2. è”ç½‘åå›ç­”
    - åœ¨å›ç­”ä¸­ï¼Œä¼˜å…ˆä½¿ç”¨å·²æœç´¢åˆ°çš„èµ„æ–™ã€‚
    - å›å¤ç»“æ„åº”æ¸…æ™°ï¼Œä½¿ç”¨åºå·ã€åˆ†æ®µç­‰æ–¹å¼å¸®åŠ©ç”¨æˆ·ç†è§£ã€‚
    ## 3. å¼•ç”¨å·²æœç´¢èµ„æ–™
    - å½“ä½¿ç”¨è”ç½‘æœç´¢çš„èµ„æ–™æ—¶ï¼Œåœ¨æ­£æ–‡ä¸­æ˜ç¡®å¼•ç”¨æ¥æºï¼Œå¼•ç”¨æ ¼å¼ä¸ºï¼š  
    `[1]  (URLåœ°å€)`ã€‚
    ## 4. æ€»ç»“ä¸å‚è€ƒèµ„æ–™
    - åœ¨å›å¤çš„æœ€åï¼Œåˆ—å‡ºæ‰€æœ‰å·²å‚è€ƒçš„èµ„æ–™ã€‚æ ¼å¼ä¸ºï¼š  
    1. [èµ„æ–™æ ‡é¢˜](URLåœ°å€1)
    2. [èµ„æ–™æ ‡é¢˜](URLåœ°å€2)
    """

    # è°ƒç”¨APIåˆ›å»ºå“åº”ï¼Œå‘èµ·AIé—®ç­”è¯·æ±‚
    response = client.responses.create(
        model="doubao-seed-1-6-250615",  # æŒ‡å®šä½¿ç”¨çš„æ¨¡å‹ID
        input=[  # è¾“å…¥å†…å®¹ï¼ŒåŒ…å«ç³»ç»Ÿæç¤ºå’Œç”¨æˆ·é—®é¢˜
            {
                "role": "system",
                "content": [{"type": "input_text", "text": system_prompt}]
            },
            {
                "role": "user",
                "content": [{"type": "input_text", "text": "ä¸–ç•Œ500å¼ºä¼ä¸šï¼Œä»–ä»¬åœ¨å›½å†…æ‰€åœ¨çš„åŸå¸‚ï¼Œè¿‘ä¸‰å¹´çš„å¹³å‡å·¥èµ„æ˜¯å¤šå°‘ï¼Ÿ"}]  # ç”¨æˆ·å…·ä½“é—®é¢˜
            }
        ],
        tools=[
            {
                "type": "web_search",  # é…ç½®å·¥å…·ç±»å‹ä¸ºåŸºç¡€è”ç½‘æœç´¢åŠŸèƒ½
                "limit": 10,  # æœ€å¤šè¿”å›10ä¸ªæœç´¢ç»“æœ
                "sources": ["douyin", "moji", "toutiao"],  # é™„åŠ æœç´¢æ¥æºï¼ˆæŠ–éŸ³ç™¾ç§‘ã€å¢¨è¿¹å¤©æ°”ã€å¤´æ¡å›¾æ–‡ç­‰å¹³å°ï¼‰
                "user_location": {  # ç”¨æˆ·åœ°ç†ä½ç½®ï¼ˆç”¨äºä¼˜åŒ–æœç´¢ç»“æœï¼‰
                    "type": "approximate",  # å¤§è‡´ä½ç½®
                    "country": "ä¸­å›½",
                    "region": "æµ™æ±Ÿ",
                    "city": "æ­å·"
                }
            }
        ],
        stream=True,  # å¯ç”¨æµå¼å“åº”ï¼ˆå®æ—¶è¿”å›ç»“æœï¼Œè€Œéç­‰å¾…å…¨éƒ¨å®Œæˆï¼‰
        extra_body={"thinking": {"type": "auto"}}, 
        parallel_tool_calls=False,  # ç¦ç”¨å¹¶è¡Œå·¥å…·è°ƒç”¨ï¼ˆå·¥å…·è°ƒç”¨æŒ‰é¡ºåºæ‰§è¡Œï¼‰
        max_tool_calls= 3,  # æœ€å¤šè°ƒç”¨3è½®å·¥å…·
        extra_headers={"ark-beta-web-search": "true"},  # é…ç½®é¢å¤–è¯·æ±‚å¤´ï¼šå¯ç”¨è”ç½‘æœç´¢åŠŸèƒ½
    )

    # åˆå§‹åŒ–çŠ¶æ€å˜é‡ï¼Œç”¨äºæ§åˆ¶è¾“å‡ºæ ¼å¼ï¼ˆé¿å…é‡å¤æ‰“å°æ ‡é¢˜ï¼‰
    thinking_started = False  # æ ‡è®°AIæ€è€ƒè¿‡ç¨‹æ˜¯å¦å·²å¼€å§‹æ‰“å°
    answering_started = False  # æ ‡è®°AIå›ç­”å†…å®¹æ˜¯å¦å·²å¼€å§‹æ‰“å°

    # éå†æµå¼å“åº”çš„æ¯ä¸ªç‰‡æ®µï¼ˆchunkï¼‰ï¼Œå®æ—¶å¤„ç†å¹¶å±•ç¤ºç»“æœ
    for chunk in response:
        # è·å–å½“å‰ç‰‡æ®µçš„ç±»å‹ï¼ˆç”¨äºåˆ¤æ–­æ˜¯æ€è€ƒè¿‡ç¨‹ã€æœç´¢çŠ¶æ€è¿˜æ˜¯å›ç­”å†…å®¹ï¼‰
        chunk_type = getattr(chunk, 'type', '')

        # 1. å¤„ç†AIæ€è€ƒè¿‡ç¨‹çš„è¾“å‡º
        if chunk_type == "response.reasoning_summary_text.delta":
            if not thinking_started:  # é¦–æ¬¡æ‰“å°æ€è€ƒè¿‡ç¨‹æ—¶ï¼Œè¾“å‡ºæ ‡é¢˜
                print("ğŸ¤” AIæ€è€ƒä¸­...")
                thinking_started = True
            # æ‰“å°æ€è€ƒå†…å®¹ï¼ˆdeltaä¸ºå½“å‰ç‰‡æ®µçš„æ–‡æœ¬å¢é‡ï¼‰
            print(getattr(chunk, 'delta', ''), end="", flush=True)

        # 2. å¤„ç†è”ç½‘æœç´¢çš„çŠ¶æ€ï¼ˆå¼€å§‹/å®Œæˆï¼‰
        elif "web_search_call" in chunk_type:
            if "in_progress" in chunk_type:  # æœç´¢å¼€å§‹æ—¶ï¼Œæ‰“å°æ—¶é—´æˆ³
                print(f"\nğŸ” å¼€å§‹æœç´¢... [{datetime.now().strftime('%H:%M:%S')}]")
            elif "completed" in chunk_type:  # æœç´¢å®Œæˆæ—¶ï¼Œæ‰“å°æç¤º
                print("âœ… æœç´¢å®Œæˆ")

        # 3. å¤„ç†æœç´¢ç»“æœä¸­çš„å…³é”®è¯ï¼ˆå±•ç¤ºAIçš„æœç´¢ç›®æ ‡ï¼‰
        elif (chunk_type == "response.output_item.done" and 
              hasattr(chunk, 'item') and str(getattr(chunk.item, 'id', '')).startswith("ws_")):
            # æå–æœç´¢å…³é”®è¯å¹¶æ‰“å°ï¼ˆæˆªå–å‰80å­—ç¬¦é¿å…è¿‡é•¿ï¼‰
            if hasattr(chunk.item, 'action') and hasattr(chunk.item.action, 'query'):
                print(f"ğŸ“ æœç´¢å…³é”®è¯: {chunk.item.action.query[:80]}...")

        # 4. å¤„ç†AIçš„æœ€ç»ˆå›ç­”å†…å®¹
        elif chunk_type == "response.output_text.delta":
            if not answering_started:  # é¦–æ¬¡æ‰“å°å›ç­”æ—¶ï¼Œè¾“å‡ºæ ‡é¢˜å’Œåˆ†éš”çº¿
                print(f"\nğŸ’¬ AIå›ç­” [{datetime.now().strftime('%H:%M:%S')}]:")
                print("-" * 50)
                answering_started = True
            # æ‰“å°å›ç­”å†…å®¹ï¼ˆdeltaä¸ºå½“å‰ç‰‡æ®µçš„æ–‡æœ¬å¢é‡ï¼‰
            print(getattr(chunk, 'delta', ''), end="", flush=True)

    # æ‰€æœ‰å“åº”å¤„ç†å®Œæˆåï¼Œæ‰“å°ç»“æŸæ—¶é—´
    print(f"\n\nâœ¨ å®Œæˆæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")

# å½“è„šæœ¬ç›´æ¥è¿è¡Œæ—¶ï¼Œæ‰§è¡Œmainå‡½æ•°
if __name__ == "__main__":
    main()